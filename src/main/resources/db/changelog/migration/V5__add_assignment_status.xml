<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.21.xsd">

    <changeSet id="V5-add-assignment-status" author="FrancoMoreal">
        <!-- Si la columna ya existe marcar la migraciÃ³n como aplicada -->
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="members" columnName="assignment_status"/>
            </not>
        </preConditions>

        <!-- Agregar la columna con valor por defecto -->
        <addColumn tableName="members">
            <column name="assignment_status" type="varchar(20)" defaultValue="NO_TRAINER">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <!-- Asegurar que filas existentes tengan el valor correcto -->
        <update tableName="members">
            <column name="assignment_status" value="NO_TRAINER"/>
            <where>assignment_status IS NULL</where>
        </update>

        <!-- Index para consultas por status -->
        <createIndex indexName="idx_member_assignment_status" tableName="members">
            <column name="assignment_status"/>
        </createIndex>

        <rollback>
            <dropIndex indexName="idx_member_assignment_status" tableName="members"/>
            <dropColumn tableName="members" columnName="assignment_status"/>
        </rollback>
    </changeSet>
</databaseChangeLog>